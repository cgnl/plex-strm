services:
  # STRM fallback proxy (tries alternative STRM IDs on Zurg 5XX)
  strm-proxy:
    build:
      context: ..
      dockerfile: examples/Dockerfile.strm-proxy
    environment:
      ZURG_URL: http://host.docker.internal:9091
      ZURG_USER: ${ZURG_USER}
      ZURG_PASS: ${ZURG_PASS}
      PROXY_PORT: "8765"
      PROXY_HOST: "0.0.0.0"
      FOLLOW_RD_REDIRECTS: ${FOLLOW_RD_REDIRECTS:-0}
      STREAM_CHUNK_SIZE: ${STREAM_CHUNK_SIZE:-4194304}
      ZURG_TIMEOUT: ${ZURG_TIMEOUT:-45}
      PLEX_DB_MODE: ${PLEX_DB_MODE:-postgres}
      PLEX_SQLITE_PATH: ${PLEX_SQLITE_PATH:-/data/com.plexapp.plugins.library.db}
      PLEX_PG_HOST: ${PLEX_PG_HOST:-host.docker.internal}
      PLEX_PG_PORT: ${PLEX_PG_PORT:-5432}
      PLEX_PG_DATABASE: ${PLEX_PG_DATABASE:-plex}
      PLEX_PG_USER: ${PLEX_PG_USER:-plex}
      PLEX_PG_PASSWORD: ${PLEX_PG_PASSWORD:-plex}
      PLEX_PG_SCHEMA: ${PLEX_PG_SCHEMA:-plex}
      ENABLE_LOCAL_FALLBACK: ${ENABLE_LOCAL_FALLBACK:-1}
      LOCAL_FALLBACK_STRICT: ${LOCAL_FALLBACK_STRICT:-1}
      LOCAL_FALLBACK_MATCH_MODE: ${LOCAL_FALLBACK_MATCH_MODE:-audio}
      LOCAL_FALLBACK_RESOLUTION_PREFERENCE: ${LOCAL_FALLBACK_RESOLUTION_PREFERENCE:-1080p}
      PLEX_TOKEN: ${PLEX_TOKEN:-}
    ports:
      - "8765:8765"
    # For SQLite mode, mount the Plex DB file into the container path set in
    # PLEX_SQLITE_PATH. Example:
    # volumes:
    #   - "/Users/you/Library/Application Support/Plex Media Server/Plug-in Support/Databases/com.plexapp.plugins.library.db:/data/com.plexapp.plugins.library.db:ro"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # Caddy front door:
  #   /strm/* -> strm-proxy
  #   everything else -> Plex on host
  caddy:
    image: ghcr.io/caddybuilds/caddy-cloudflare:latest
    depends_on:
      - strm-proxy
    ports:
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:
